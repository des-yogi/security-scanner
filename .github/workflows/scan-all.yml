name: Scan all repos for Shai-Hulud patterns

on:
  workflow_dispatch: {}   # запуск вручную из UI Actions
  schedule:
    - cron: "0 4 * * *"   # ежедневно в 04:00 UTC (можно удалить/изменить)

jobs:
  scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout scanner repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm install @octokit/rest

      - name: Run central Shai-Hulud scan
        env:
          GH_PAT_SH_SCAN: ${{ secrets.GH_PAT_SH_SCAN }}
          SCAN_USER: "des-yogi"
        run: |
          node scan-all-repos-via-api.js

      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        with:
          name: shai-hulud-scan-report
          path: scan-report.json
