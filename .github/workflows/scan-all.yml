name: Scan all repos for Shai-Hulud patterns

on:
  workflow_dispatch: {}   # запуск вручную из UI Actions
  schedule:
    - cron: "0 4 * * *"   # ежедневно в 04:00 UTC (можно удалить/изменить)

jobs:
  scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout scanner repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm install @octokit/rest

      - name: Run central Shai-Hulud scan
        env:
          GH_PAT_SH_SCAN: ${{ secrets.GH_PAT_SH_SCAN }}
          SCAN_USER: "des-yogi"
        run: |
          node scan-all-repos-via-api.js

      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        with:
          name: shai-hulud-scan-report
          path: scan-report.json
```

Пояснения по шагам:

- `on.workflow_dispatch`: позволяет тебе запускать скан **вручную** кнопкой из UI.
- `on.schedule`: будет запускать автоматически по крону (можно удалить, если не нужно авто‑сканирование).
- `Install dependencies`: ставит в этом репозитории библиотеку `@octokit/rest`, чтобы наш скрипт мог общаться с GitHub API.
- `Run central Shai-Hulud scan`:
  - подставляет в переменную окружения `GH_PAT_SH_SCAN` твой секретный токен;
  - задаёт `SCAN_USER = "des-yogi"`, чтобы скрипт знал, чьи репо сканировать.
- `Upload JSON report`: прикрепляет файл `scan-report.json` как артефакт, который можно скачать после выполнения job.

4. Внизу:
   - **Commit message**: `Add global scan workflow`.
   - Нажми **Commit new file**.

---

## 5. Первый запуск сканера

Теперь у тебя есть:

- репозиторий `security-scanner`;
- в нём:
  - `scan-all-repos-via-api.js`;
  - `.github/workflows/scan-all.yml`;
- секрет `GH_PAT_SH_SCAN` с токеном.

Запустим всё это.

1. Зайди в репозиторий `security-scanner`.
2. Открой вкладку **Actions**.
3. В списке workflow увидишь **Scan all repos for Shai-Hulud patterns**.
4. Нажми на него.
5. Справа вверху будет кнопка **Run workflow**:
   - нажми её;
   - в появившемся окошке просто ещё раз **Run workflow**.

После этого:

- появится новый ран `#1` (или другой номер);
- он будет в статусе **In progress** (желтый кружок);
- кликни на него, чтобы посмотреть шаги.

---

## 6. Как смотреть результат

После завершения job (зелёный или жёлтый значок):

### Вариант A: посмотреть лог

1. Открой конкретный запуск workflow (тот, что только что запустили).
2. В секции **Jobs** кликни по `scan`.
3. Внутри будут шаги:
   - `Checkout scanner repo`
   - `Setup Node.js`
   - `Install dependencies`
   - `Run central Shai-Hulud scan`
   - `Upload JSON report`

4. Кликни по шагу **Run central Shai-Hulud scan**:
   - внизу откроется лог;
   - там будет примерно такое:

   ```text
   === Central Shai-Hulud scan via GitHub API ===
   Scanning user: des-yogi
   Всего репозиториев у des-yogi: XX

   [SCAN] des-yogi/some-repo
     [OK] Ничего подозрительного не найдено.

   [SCAN] des-yogi/another-repo
     [WARN] Найдено проблем: 1
       [scripts]
         - preinstall: node some-script.js
   ...
   === SUMMARY ===
   Всего находок: N
   Отчёт сохранён в /home/runner/work/security-scanner/security-scanner/scan-report.json
   ```

### Вариант B: скачать JSON‑отчёт

1. На странице запуска workflow ниже по странице будет блок **Artifacts**.
2. Там появится артефакт с именем `shai-hulud-scan-report`.
3. Нажми на него → скачай `.zip`.
4. Распакуй — внутри будет `scan-report.json`.

Пример структуры `scan-report.json`:

```json
[
  {
    "type": "lifecycle-script",
    "repo": "des-yogi/another-repo",
    "details": {
      "scripts": {
        "preinstall": "node some-script.js"
      }
    }
  },
  {
    "type": "compromised-dependency",
    "repo": "des-yogi/some-repo",
    "details": {
      "section": "dependencies",
      "name": "shai-hulud",
      "versionRange": "^1.0.0",
      "reason": "Known Shai-Hulud worm package (example)",
      "badVersions": ["*"]
    }
  }
]
```

- `type: "lifecycle-script"` — в этом репо есть потенциально опасные скрипты в `package.json`.
- `type: "compromised-dependency"` — репо использует пакет из твоего списка «плохих».

---

## 7. Кратко: что мы получили

- Один приватный репозиторий `security-scanner`.
- Один workflow `scan-all.yml`, который:
  - **по кнопке** или по крону:
    - запускается на GitHub runner;
    - по API обходит **все твои репозитории** (`des-yogi`);
    - читает только `package.json` из каждого, без клона;
    - ищет:
      - lifecycle‑скрипты;
      - пакеты из списка `COMPROMISED_PACKAGES`.
  - отдаёт:
    - детальный лог в UI Actions;
    - `scan-report.json` как артефакт.

Ты не трогаешь каждый репозиторий по отдельности и ничего не клонируешь локально.

---

## 8. Что можно улучшить потом (по желанию)

После того как первый запуск отработает:

- можно:
  - расширить список `COMPROMISED_PACKAGES` реальными данными;
  - добавить фильтр:
    - сканировать только репозитории, где были коммиты за последние N месяцев (по полю `pushed_at`);
  - сделать «жёсткий режим»:
    - например, открывать issue в репозитории, где что‑то найдено (это отдельный шаг, можно сделать позже).

---

Если хочешь, следующим шагом могу:

- добавить в этот же скрипт фильтр по дате активности репозитория (чтобы не тревожить совсем древний хлам);
- или показать, как по `scan-report.json` быстро найти все репозитории, которые требуют твоего внимания.
